const char PROGMEM INDEX_HTML[] = R"=====(
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sterowanie Piecem Peletowym ESP32</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--primary:#2c3e50;--secondary:#3498db;--danger:#e74c3c;--warning:#f39c12;--success:#2ecc71;--dark:#1a252f;--flame-on:#ff5722;--flame-off:#555;--igniter-heating:#ff9800;--igniter-ready:#9c27b0;--feeder-color:#8e44ad;--blower-color:#1abc9c;--maintenance-color:#9b59b6;--clean-color:#e67e22;--pellet-color:#d35400;--mqtt-connected:#2ecc71;--mqtt-disconnected:#e74c3c;--feeder-forward-color:#2ecc71; /* Green */ --feeder-pause-color:#e74c3c; /* Red */ --feeder-reverse-color:#9b59b6; /* Purple */}*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}body{background:linear-gradient(135deg,var(--dark),var(--primary));color:white;min-height:100vh;padding:20px;line-height:1.6;}.container{max-width:1200px;margin:0 auto;}header{text-align:center;padding:20px 0;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.2);border-radius:15px;}h1{font-size:2.5rem;margin-bottom:10px;color:white;display:flex;align-items:center;justify-content:center;gap:15px;}.subtitle{font-size:1.1rem;color:#3498db;max-width:800px;margin:0 auto;}.dashboard{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;}@media (max-width:992px){.dashboard{grid-template-columns:1fr;}}.card{background:rgba(255,255,255,0.08);border-radius:15px;padding:25px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.15);box-shadow:0 10px 35px rgba(0,0,0,0.3);transition:all 0.3s ease;}.card:hover{transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,0,0,0.4);}.card-title{font-size:1.5rem;margin-bottom:20px;color:#3498db;display:flex;align-items:center;gap:10px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);}.card-title i{font-size:1.8rem;}.status-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;}.status-item{background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;text-align:center;transition:transform 0.3s;}.status-item:hover{transform:scale(1.03);background:rgba(0,0,0,0.3);}.status-label{font-size:1rem;color:#bbb;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:8px;}.status-value{font-size:2rem;font-weight:bold;color:white;}.status-unit{font-size:1.2rem;color:#7f8c8d;}.progress-container{background:rgba(0,0,0,0.3);border-radius:10px;height:20px;margin:15px 0;overflow:hidden;}.progress-bar{height:100%;border-radius:10px;transition:width 0.5s ease;}.heating-bar{background:linear-gradient(90deg,#ff9800,#ff5722);}.ignition-bar{background:linear-gradient(90deg,#3498db,#2ecc71);}.feeder-bar{background:linear-gradient(90deg,var(--feeder-color),#9b59b6);}.blower-bar{background:linear-gradient(90deg,var(--blower-color),#16a085);}.maintenance-bar{background:linear-gradient(90deg,var(--maintenance-color),#8e44ad);}.clean-bar{background:linear-gradient(90deg,var(--clean-color),#d35400);}.control-group{margin-bottom:25px;}.slider-container{background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;margin:18px 0;}.slider-label{display:flex;justify-content:space-between;margin-bottom:12px;font-size:1.1rem;}input[type="range"]{width:100%;height:30px;-webkit-appearance:none;background:rgba(255,255,255,0.1);border-radius:15px;outline:none;}input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:30px;height:30px;border-radius:50%;background:#3498db;cursor:pointer;box-shadow:0 0 10px rgba(52,152,219,0.5);transition:all 0.3s;}input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.1);background:#2980b9;}input[type="range"]:active{transform:translateY(1px);}button{padding:16px;border:none;border-radius:12px;background:#3498db;color:white;font-size:1.15rem;font-weight:bold;cursor:pointer;transition:all 0.3s;margin:8px 0;display:flex;align-items:center;justify-content:center;gap:10px;width:100%;}button:hover{background:#2980b9;transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}button:active{transform:translateY(1px);}button.power-off{background:#e74c3c;}button.power-off:hover{background:#c0392b;}button.warning{background:#f39c12;}button.warning:hover{background:#e67e22;}button.success{background:#2ecc71;}button.success:hover{background:#27ae60;}.mode-buttons{display:flex;gap:12px;margin:18px 0;}.mode-button{flex:1;text-align:center;padding:16px;border-radius:12px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:10px;}.mode-button:hover{background:rgba(255,255,255,0.15);}.mode-button.active{background:#3498db;box-shadow:0 0 20px rgba(52,152,219,0.4);}.log{background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;height:200px;overflow-y:auto;margin-top:20px;}.log-entry{padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-size:0.95rem;display:flex;}.log-time{color:#3498db;min-width:70px;font-weight:bold;}.chart-container{height:300px;margin-top:20px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;position:relative;}.tabs{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}.tab{padding:10px 20px;border-radius:8px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.tab.active{background:#3498db;}.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;}.stat-card{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.stat-title{font-size:1.1rem;margin-bottom:10px;color:#3498db;text-align:center;}.stat-value{font-size:1.8rem;font-weight:bold;text-align:center;margin:10px 0;}.stat-sub{display:flex;justify-content:space-between;font-size:0.9rem;color:#bbb;}.diagram{display:flex;justify-content:space-around;align-items:center;margin:25px 0;padding:20px;background:rgba(0,0,0,0.2);border-radius:15px;flex-wrap:wrap;gap:10px;}.diagram-component{text-align:center;position:relative;min-width:100px;}.diagram-component i{font-size:2.8rem;margin-bottom:10px;color:#3498db;}.diagram-arrow{font-size:2.5rem;color:#3498db;}.ignition-container{display:flex;flex-direction:column;align-items:center;margin:20px 0;}.flame-indicator{width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;transition:all 0.5s ease;margin-bottom:15px;position:relative;overflow:hidden;}.flame-indicator.on{background:var(--flame-on);box-shadow:0 0 30px var(--flame-on);animation:flamePulse 1.5s infinite;}.flame-indicator.off{background:var(--flame-off);}.igniter-indicator{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;background:var(--igniter-heating);opacity:0.8;animation:heatingPulse 2s infinite;}.igniter-indicator.ready{background:var(--igniter-ready);animation:readyPulse 1s infinite;}@keyframes flamePulse{0%{box-shadow:0 0 15px var(--flame-on);}50%{box-shadow:0 0 40px var(--flame-on);}100%{box-shadow:0 0 15px var(--flame-on);}}@keyframes heatingPulse{0%{box-shadow:0 0 10px var(--igniter-heating);opacity:0.6;}50%{box-shadow:0 0 25px var(--igniter-heating);opacity:0.9;}100%{box-shadow:0 0 10px var(--igniter-heating);opacity:0.6;}}@keyframes readyPulse{0%{box-shadow:0 0 10px var(--igniter-ready);opacity:0.7;}50%{box-shadow:0 0 30px var(--igniter-ready);opacity:1;}100%{box-shadow:0 0 10px var(--igniter-ready);opacity:0.7;}}.ignition-status{font-size:1.3rem;font-weight:bold;text-align:center;padding:10px 20px;border-radius:20px;margin-top:10px;}.ignition-status.heating{background:rgba(255,152,0,0.2);color:#ff9800;}.ignition-status.ready{background:rgba(156,39,176,0.2);color:#9c27b0;}.ignition-status.on{background:rgba(255,87,34,0.2);color:#ff5722;}.ignition-status.off{background:rgba(85,85,85,0.2);color:#bbb;}.ignition-timer{display:flex;align-items:center;justify-content:center;gap:10px;margin:15px 0;font-size:1.2rem;}.timer-value{font-weight:bold;color:#f39c12;min-width:40px;text-align:center;}.ignition-progress{display:flex;align-items:center;justify-content:center;gap:10px;margin:15px 0;}.progress-circle{width:100px;height:100px;border-radius:50%;background:conic-gradient(#ff9800 0%,#ff5722 0%,rgba(0,0,0,0.3) 0%);display:flex;align-items:center;justify-content:center;position:relative;}.progress-text{font-size:1.5rem;font-weight:bold;position:absolute;}.temperature-display{font-size:1.1rem;margin-top:5px;color:#ff9800;}footer{text-align:center;margin-top:40px;padding:25px;color:#7f8c8d;font-size:1rem;border-top:1px solid rgba(255,255,255,0.1);}.auto-clean{display:flex;align-items:center;gap:10px;margin:15px 0;background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;justify-content:space-between;}.auto-clean-label{display:flex;align-items:center;gap:10px;font-size:1.1rem;}.clean-timer{background:rgba(255,255,255,0.1);border-radius:8px;padding:8px 15px;font-weight:bold;}.switch{position:relative;display:inline-block;width:60px;height:30px;}.switch input{opacity:0;width:0;height:0;}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:30px;}.slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%;}input:checked+.slider{background-color:#3498db;}input:checked+.slider:before{transform:translateX(30px);}.feeder-info,.blower-info{display:flex;align-items:center;gap:15px;margin:15px 0;}.feeder-icon,.blower-icon{font-size:2rem;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;}.feeder-icon{background:rgba(142,68,173,0.2);color:var(--feeder-color);}.blower-icon{background:rgba(26,188,156,0.2);color:var(--blower-color);}.feeder-details,.blower-details{flex:1;}.control-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:1.1rem;}.fixed-blower{background:rgba(0,0,0,0.25);border-radius:12px;padding:15px;text-align:center;margin-top:15px;}.status-indicator{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;}.status-active{background-color:var(--success);box-shadow:0 0 8px var(--success);}.status-inactive{background-color:var(--danger);}.status-warning{background-color:var(--warning);box-shadow:0 0 8px var(--warning);}.status-ready{background-color:var(--igniter-ready);box-shadow:0 0 8px var(--igniter-ready);}.time-control{display:flex;justify-content:space-between;align-items:center;margin:10px 0;gap:15px;}.time-input{flex:1;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;text-align:center;}.time-input label{display:block;margin-bottom:5px;color:#3498db;font-weight:bold;}.time-input input{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:white;text-align:center;font-size:1.1rem;}.feeder-cycle{display:flex;flex-direction:column;align-items:center;margin-top:15px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.cycle-progress{width:100%;height:20px;background:rgba(0,0,0,0.3);border-radius:10px;margin:10px 0;overflow:hidden;position:relative;}.cycle-progress-bar{height:100%;border-radius:10px;transition:width 0.5s;}.cycle-status{font-weight:bold;margin-top:5px;display:flex;align-items:center;gap:5px;}.cycle-status.on{color:#2ecc71;}.cycle-status.off{color:#e74c3c;}.maintenance-indicator{padding:5px 10px;border-radius:15px;font-weight:bold;}.maintenance-active{background:rgba(46,204,113,0.2);color:#2ecc71;}.maintenance-inactive{background:rgba(231,76,60,0.2);color:#e74c3c;}.edit-clean-container{background:rgba(0,0,0,0.25);border-radius:12px;padding:15px;margin-top:15px;}.edit-clean-header{display:flex;align-items:center;gap:10px;margin-bottom:15px;font-size:1.1rem;}.edit-clean-fields{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:center;}.edit-time-input{text-align:center;}.edit-time-input label{display:block;margin-bottom:5px;color:#3498db;}.edit-time-input input{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:white;text-align:center;font-size:1.1rem;}#update-clean-btn{height:40px;align-self:flex-end;margin-bottom:5px;padding:8px 15px;font-size:0.9rem;}.notification-badge{position:absolute;top:-5px;right:-5px;background:var(--danger);color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:bold;}.notification-container{position:relative;}.blower-info-box{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;margin-top:15px;text-align:center;}.blower-cycle{display:flex;flex-direction:column;align-items:center;margin-top:15px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.blower-status{font-weight:bold;margin-top:5px;display:flex;align-items:center;gap:5px;}.blower-status.on{color:#2ecc71;}.blower-status.off{color:#e74c3c;}.blower-progress{width:100%;height:20px;background:rgba(0,0,0,0.3);border-radius:10px;margin:10px 0;overflow:hidden;position:relative;}.blower-progress-bar{height:100%;background:linear-gradient(90deg,var(--blower-color),#16a085);transition:width 0.5s;}.control-btn{padding:8px 15px;border-radius:8px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.control-btn:hover{background:rgba(255,255,255,0.15);}.control-btn.active{background:#3498db;}.blower-mode-info{margin-top:10px;padding:8px;border-radius:8px;background:rgba(0,0,0,0.2);}.mode-direct{background:rgba(231,76,60,0.2);color:#e74c3c;}.mode-inverter{background:rgba(46,204,113,0.2);color:#2ecc71;}.system-status{display:flex;justify-content:center;gap:15px;margin-top:15px;}.status-badge{padding:8px 15px;border-radius:20px;font-weight:bold;display:flex;align-items:center;gap:8px;}.status-good{background:rgba(46,204,113,0.2);color:#2ecc71;}.status-warning{background:rgba(243,156,18,0.2);color:#f39c12;}.status-error{background:rgba(231,76,60,0.2);color:#e74c3c;}.device-status{display:flex;justify-content:space-around;margin-top:15px;padding:10px;background:rgba(0,0,0,0.2);border-radius:12px;}.status-item{text-align:center;}.chart-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}.dataset-toggle{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;background:rgba(255,255,255,0.1);cursor:pointer;}.dataset-toggle.active{background:rgba(52,152,219,0.3);}.chart-color-indicator{width:15px;height:15px;border-radius:50%;}.history-stats{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;}.history-card{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.history-title{font-size:1.1rem;margin-bottom:10px;color:#3498db;text-align:center;}.history-value{font-size:1.5rem;font-weight:bold;text-align:center;margin:10px 0;}.cost-calculation{background:rgba(0,0,0,0.15);border-radius:12px;padding:15px;margin-top:15px;}.cost-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);}.cost-total{font-weight:bold;font-size:1.2rem;margin-top:10px;padding-top:10px;border-top:2px solid rgba(255,255,255,0.2);}.efficiency-gauge{width:100%;height:30px;background:rgba(0,0,0,0.3);border-radius:15px;overflow:hidden;position:relative;}.gauge-fill{height:100%;background:linear-gradient(90deg,#3498db,#2ecc71);transition:width 0.5s;}.gauge-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-weight:bold;text-shadow:0 0 3px rgba(0,0,0,0.8);}.chart-switcher{display:flex;gap:10px;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}.chart-switch{padding:8px 15px;border-radius:20px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.chart-switch.active{background:rgba(52,152,219,0.3);}.zoom-controls{position:absolute;top:10px;right:10px;display:flex;gap:5px;z-index:10;background:rgba(0,0,0,0.5);border-radius:20px;padding:5px;}.zoom-btn{width:30px;height:30px;border-radius:50%;background:#3498db;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;font-size:18px;transition:background 0.3s;}.zoom-btn:hover{background:#2980b9;}.zoom-btn.reset{background:#e74c3c;}.zoom-btn.reset:hover{background:#c0392b;}.history-range{display:flex;gap:10px;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}.history-btn{padding:8px 15px;border-radius:20px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.history-btn.active{background:rgba(52,152,219,0.3);}.tab-content{display:none;}.tab-content.active{display:block;}.instructions{background:rgba(0,0,0,0.2);border-radius:15px;padding:20px;margin-top:20px;}.instructions h3{color:#3498db;margin-bottom:15px;display:flex;align-items:center;gap:10px;}.instructions ul{padding-left:25px;}.instructions li{margin-bottom:10px;line-height:1.5;}.instructions strong{color:#3498db;}.controls{display:flex;justify-content:center;align-items:center;gap:0.8rem;margin:1.2rem 0;flex-wrap:wrap;}.control-btn{padding:0.6rem 1.2rem;background-color:rgba(0,0,0,0.25);border:2px solid var(--secondary);border-radius:30px;color:var(--secondary);font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:0.5rem;}.control-btn:hover{background-color:var(--secondary);color:white;}.date-display{font-weight:600;color:white;background-color:rgba(0,0,0,0.3);padding:0.5rem 1.2rem;border-radius:30px;min-width:250px;text-align:center;}.tab-btn{padding:0.7rem 1.2rem;background-color:rgba(0,0,0,0.25);border:none;border-radius:30px;cursor:pointer;font-weight:600;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;color:white;}.tab-btn.active{background-color:var(--secondary);color:white;}.tab-btn:hover:not(.active){background-color:rgba(255,255,255,0.15);}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-top:1.5rem;}.stat-card-monitor{background:linear-gradient(135deg,var(--secondary),var(--primary));color:white;padding:1rem;border-radius:8px;text-align:center;transition:transform 0.3s ease;}.stat-card-monitor:hover{transform:scale(1.03);}.stat-card-monitor .value{font-size:1.8rem;font-weight:700;margin:0.5rem 0;}.stat-card-monitor .label{font-size:0.9rem;opacity:0.9;display:flex;align-items:center;justify-content:center;gap:5px;}.stat-card-monitor i{font-size:1.2rem;}.correction-info{background:rgba(0,0,0,0.25);border-radius:12px;padding:15px;margin-top:15px;text-align:center;}.correction-value{font-size:1.5rem;font-weight:bold;color:#f39c12;}.correction-controls{display:flex;gap:10px;margin-top:10px;}.correction-input{flex:1;background:rgba(0,0,0,0.2);border:1px solid #f39c12;border-radius:8px;padding:8px;color:white;text-align:center;font-size:1.1rem;}.correction-btn{padding:8px 15px;border-radius:8px;background:#f39c12;color:white;border:none;cursor:pointer;font-weight:bold;transition:all 0.3s;}.correction-btn:hover{background:#e67e22;}.reset-stats-btn{background:#9b59b6;margin-top:15px;}.reset-stats-btn:hover{background:#8e44ad;}/* MQTT Configuration Panel */.mqtt-config{background:rgba(0,0,0,0.25);border-radius:15px;padding:20px;margin-bottom:20px;}.mqtt-config h3{color:#3498db;margin-bottom:15px;display:flex;align-items:center;gap:10px;}.mqtt-form{display:grid;grid-template-columns:1fr 1fr;gap:15px;}.mqtt-field{margin-bottom:15px;}.mqtt-field label{display:block;margin-bottom:5px;color:#3498db;font-weight:bold;}.mqtt-field input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.2);color:white;}.mqtt-actions{display:flex;gap:10px;margin-top:10px;grid-column:span 2;}.mqtt-status{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.3);margin-top:15px;}.mqtt-indicator{width:12px;height:12px;border-radius:50%;background-color:var(--mqtt-disconnected);}.mqtt-indicator.connected{background-color:var(--mqtt-connected);box-shadow:0 0 8px var(--mqtt-connected);}.mqtt-topic-list{margin-top:20px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.topic-item{padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-family:monospace;display:flex;justify-content:space-between;}.topic-item:last-child{border-bottom:none;}.mqtt-log{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;margin-top:15px;height:150px;overflow-y:auto;}.mqtt-log-entry{font-family:monospace;font-size:0.9rem;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.1);}.mqtt-log-entry:last-child{border-bottom:none;}.mqtt-log-topic{color:#3498db;font-weight:bold;}.mqtt-log-message{color:#f39c12;}
        /* Dodano dla poprawy obsługi dotyku na canvas */
        canvas {
            touch-action: none;
        }

        /* Styles for new blower controls */
        .blower-manual-controls {
            display: none; /* Hidden by default, shown when blowerManualToggle is checked */
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-fire"></i> Symulator Pieca Peletowego z MQTT</h1>
            <div class="subtitle">Sterowanie przez ESP32 z obsługą pełnej historii danych i korektą</div>
            <div class="system-status">
                <div class="status-badge status-good">
                    <i class="fas fa-history"></i>
                    Pełna historia danych
                </div>
                <div class="status-badge status-good">
                    <i class="fas fa-wifi"></i>
                    Sterowanie przez MQTT
                </div>
                <div class="status-badge status-good">
                    <i class="fas fa-microchip"></i>
                    Kompatybilne z ESP32
                </div>
            </div>
        </header>
        
        <div class="mqtt-config">
            <h3><i class="fas fa-wifi"></i> Konfiguracja połączenia MQTT</h3>
            <div class="mqtt-form">
                <div class="mqtt-field">
                    <label for="mqtt-broker">Adres brokera MQTT</label>
                    <input type="text" id="mqtt-broker" value="broker.emqx.io">
                </div>
                <div class="mqtt-field">
                    <label for="mqtt-port">Port</label>
                    <input type="number" id="mqtt-port" value="8083">
                </div>
                <div class="mqtt-field">
                    <label for="mqtt-username">Nazwa użytkownika</label>
                    <input type="text" id="mqtt-username" value="agentsan007">
                </div>
                <div class="mqtt-field">
                    <label for="mqtt-password">Hasło</label>
                    <input type="password" id="mqtt-password" value="Sanders24*">
                </div>
                <div class="mqtt-actions">
                    <button id="mqtt-connect-btn" class="success">
                        <i class="fas fa-plug"></i> Połącz
                    </button>
                    <button id="mqtt-disconnect-btn" class="danger">
                        <i class="fas fa-plug"></i> Rozłącz
                    </button>
                </div>
            </div>
            
            <div class="mqtt-status">
                <div class="mqtt-indicator" id="mqtt-status-indicator"></div>
                <span id="mqtt-status-text">Rozłączono</span>
            </div>
            
            <div class="mqtt-topic-list">
                <h4><i class="fas fa-list"></i> Aktywne tematy</h4>
                <div class="topic-item">
                    <span>pellet/boiler/state</span>
                    <span>Publikowanie stanu</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/control</span>
                    <span>Odbieranie poleceń</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/target_temp</span>
                    <span>Ustawianie temperatury</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/power</span>
                    <span>Włączanie/wyłączanie</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/blower_power</span>
                    <span>Sterowanie mocą dmuchawy</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/feeder_times</span>
                    <span>Czasy podajnika</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/ash_clean</span>
                    <span>Czyszczenie popiołu</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/maintenance_mode</span>
                    <span>Tryb konserwacji</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/burner_correction</span>
                    <span>Korekta temperatury palnika</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/reset_session</span>
                    <span>Reset sesji</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/reset_history</span>
                    <span>Reset historii</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/blower_manual_control</span>
                    <span>Ręczne sterowanie dmuchawą</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/blower_purge_mode</span>
                    <span>Tryb przedmuchu dmuchawy</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/blower_purge_settings</span>
                    <span>Ustawienia przedmuchu dmuchawy</span>
                </div>
            </div>
            
            <div class="mqtt-log">
                <h4><i class="fas fa-terminal"></i> Log komunikacji MQTT</h4>
                <div id="mqtt-log">
                    <div class="mqtt-log-entry"><span class="mqtt-log-time">[HH:MM:SS]</span> <span class="mqtt-log-topic">MQTT</span>: <span class="mqtt-log-message">Oczekiwanie na połączenie...</span></div>
                </div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-fire"></i> Sterowanie Piecem</h2>
                
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">
                            <i class="fas fa-temperature-high"></i> Temperatura wody
                            <span class="status-indicator" id="water-status"></span>
                        </div>
                        <div class="status-value" id="water-temp">--.-°C</div>
                        <div class="progress-container">
                            <div class="progress-bar ignition-bar" id="water-progress" style="width: 0%;"></div>
                        </div>
                        <div class="status-label">Cel: <span id="target-temp">--</span>°C</div>
                        
                        <div class="device-status">
                            <div class="status-item">
                                <div class="status-label">
                                    <i class="fas fa-wind"></i> Dmuchawa
                                </div>
                                <span class="status-indicator status-inactive" id="blower-status-indicator-mini"></span>
                            </div>
                            <div class="status-item">
                                <div class="status-label">
                                    <i class="fas fa-conveyor-belt"></i> Podajnik
                                </div>
                                <span class="status-indicator status-inactive" id="feeder-status-indicator-mini"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-home"></i> Temperatura pokojowa</div>
                        <div class="status-value" id="room-temp">--.-°C</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-fire"></i> Temperatura palnika</div>
                        <div class="status-value" id="burner-temp">--.-°C</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-smoke"></i> Temperatura spalin</div>
                        <div class="status-value" id="exhaust-temp">--.-°C</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <button id="power-btn" class="danger"><i class="fas fa-power-off"></i> WYŁĄCZONY</button>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span><i class="fas fa-thermometer-half"></i> Temperatura docelowa:</span>
                        <span id="target-display">70°C</span>
                    </div>
                    <input type="range" id="target-slider" min="40" max="85" value="70">
                </div>
                
                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-conveyor-belt" style="color: var(--feeder-color);"></i>
                        <span>Zaawansowane sterowanie podajnikiem</span>
                    </div>
                    
                    <div class="time-control">
                        <div class="time-input">
                            <label for="feed-time">Czas podawania (s)</label>
                            <input type="number" id="feed-time" min="1" value="5">
                        </div>
                        
                        <div class="time-input">
                            <label for="pause-time">Czas przerwy (s)</label>
                            <input type="number" id="pause-time" min="1" value="30">
                        </div>
                    </div>
                    
                    <div class="feeder-cycle">
                        <div class="cycle-status off" id="feeder-status"><span class="status-indicator status-inactive"></span> PODAJNIK: PRZERWA</div>
                        <div class="cycle-progress">
                            <div class="cycle-progress-bar" id="cycle-progress-bar" style="width: 0%; background: var(--feeder-pause-color);"></div>
                        </div>
                        <div id="feeder-cycle-timer" class="timer-value">00:00</div>
                    </div>
                </div>

                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-fan" style="color: var(--blower-color);"></i>
                        <span>Sterowanie Dmuchawą</span>
                    </div>
                    <div class="feeder-info">
                        <div class="feeder-icon"><i class="fas fa-wind"></i></div>
                        <div class="feeder-details">
                            <div class="status-label">Aktualna moc dmuchawy</div>
                            <div class="status-value" id="blower-power-display">0%</div>
                            <div class="progress-container">
                                <div class="progress-bar blower-bar" id="blower-power-progress" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="time-control">
                        <div class="time-input">
                            <label for="blower-power-work">Moc dmuchawy (praca)</label>
                            <input type="range" id="blower-power-work" min="0" max="100" value="70">
                            <span id="blower-power-work-display">70%</span>
                        </div>
                    </div>

                    <div class="time-control">
                        <div class="time-input">
                            <label for="blower-power-maintenance">Moc dmuchawy (konserwacja)</label>
                            <input type="range" id="blower-power-maintenance" min="0" max="100" value="30">
                            <span id="blower-power-maintenance-display">30%</span>
                        </div>
                    </div>

                    <div class="time-control">
                        <div class="time-input">
                            <label for="blower-power-purge">Moc dmuchawy (przedmuch)</label>
                            <input type="range" id="blower-power-purge" min="0" max="100" value="100">
                            <span id="blower-power-purge-display">100%</span>
                        </div>
                    </div>
                    
                    <div class="auto-clean">
                        <div class="auto-clean-label">
                            <i class="fas fa-toggle-on"></i> Ręczne sterowanie dmuchawą:
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="blowerManualToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="blower-manual-controls" style="display: none;">
                        <div class="slider-container">
                            <div class="slider-label">
                                <span><i class="fas fa-fan"></i> Ręczna moc dmuchawy:</span>
                                <span id="manualBlowerPowerDisplay">0%</span>
                            </div>
                            <input type="range" id="manualBlowerPowerSlider" min="0" max="100" value="0">
                        </div>
                    </div>

                    <div class="auto-clean">
                        <div class="auto-clean-label">
                            <i class="fas fa-wind"></i> Włącz przedmuch dmuchawy:
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="blowerPurgeToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="time-control" id="blower-purge-settings" style="display: none;">
                        <div class="time-input">
                            <label for="blower-purge-time">Czas przedmuchu (s)</label>
                            <input type="number" id="blower-purge-time" min="1" value="10">
                        </div>
                        <div class="time-input">
                            <label for="blower-purge-interval">Interwał przedmuchu (min)</label>
                            <input type="number" id="blower-purge-interval" min="1" value="60">
                        </div>
                    </div>
                </div>

                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-brush" style="color: var(--clean-color);"></i>
                        <span>Czyszczenie popiołu</span>
                    </div>
                    <button id="clean-ash-btn" class="warning"><i class="fas fa-broom"></i> Uruchom czyszczenie popiołu</button>
                    <div class="edit-clean-container">
                        <div class="edit-clean-header">
                            <i class="fas fa-clock"></i> Ustaw czas do następnego czyszczenia
                        </div>
                        <div class="edit-clean-fields">
                            <div class="edit-time-input">
                                <label for="clean-hours">Godziny</label>
                                <input type="number" id="clean-hours" min="0" value="0">
                            </div>
                            <div class="edit-time-input">
                                <label for="clean-minutes">Minuty</label>
                                <input type="number" id="clean-minutes" min="0" max="59" value="0">
                            </div>
                            <div class="edit-time-input">
                                <label for="clean-seconds">Sekundy</label>
                                <input type="number" id="clean-seconds" min="0" max="59" value="0">
                            </div>
                            <button id="update-clean-btn" class="success"><i class="fas fa-save"></i> Zapisz</button>
                        </div>
                    </div>
                </div>

                <div class="correction-info">
                    <h3 class="card-title"><i class="fas fa-wrench"></i> Korekta Temperatury Palnika</h3>
                    <div class="correction-value" id="burner-correction-display">0.0°C</div>
                    <div class="correction-controls">
                        <input type="number" step="0.1" id="burnerTempCorrectionInput" class="correction-input" placeholder="Wartość korekty">
                        <button id="saveBurnerCorrectionBtn" class="correction-btn success">Zapisz</button>
                        <button id="resetBurnerCorrectionBtn" class="correction-btn danger">Resetuj</button>
                    </div>
                </div>

                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-oil-can" style="color: var(--maintenance-color);"></i>
                        <span>Tryb konserwacji</span>
                    </div>
                    <div class="feeder-info">
                        <div class="feeder-icon" style="background: rgba(155, 89, 182, 0.2); color: var(--maintenance-color);"><i class="fas fa-tools"></i></div>
                        <div class="feeder-details">
                            <div class="status-label">Status konserwacji</div>
                            <div class="maintenance-indicator maintenance-inactive" id="maintenance-status">NIEAKTYWNY</div>
                        </div>
                    </div>
                    <div class="time-control">
                        <div class="time-input">
                            <label for="maintenance-feed-time">Czas podawania (s)</label>
                            <input type="number" id="maintenance-feed-time" min="1" value="2">
                        </div>
                        <div class="time-input">
                            <label for="maintenance-pause-time">Czas przerwy (s)</label>
                            <input type="number" id="maintenance-pause-time" min="1" value="5">
                        </div>
                    </div>
                    <button id="toggleMaintenanceModeBtn" class="warning"><i class="fas fa-toggle-on"></i> Włącz tryb konserwacji</button>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Monitoring i statystyki</h2>

                <div class="chart-switcher">
                    <div class="chart-switch active" id="main-chart-switcher-temp">
                        <i class="fas fa-chart-line"></i> Temperatura
                    </div>
                    <div class="chart-switch" id="main-chart-switcher-consumption">
                        <i class="fas fa-gas-pump"></i> Zużycie Pelletu
                    </div>
                </div>

                <div id="temperature-chart-section" class="tab-content active">
                    <div class="chart-controls">
                        <div class="dataset-toggle active" id="toggle-water-temp">
                            <span class="chart-color-indicator" style="background-color: #3498db;"></span> Woda
                        </div>
                        <div class="dataset-toggle active" id="toggle-room-temp">
                            <span class="chart-color-indicator" style="background-color: #e67e22;"></span> Pokój
                        </div>
                        <div class="dataset-toggle active" id="toggle-burner-temp">
                            <span class="chart-color-indicator" style="background-color: #e74c3c;"></span> Palnik
                        </div>
                        <div class="dataset-toggle active" id="toggle-exhaust-temp">
                            <span class="chart-color-indicator" style="background-color: #9b59b6;"></span> Spaliny
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                        <div class="zoom-controls">
                            <div class="zoom-btn" id="zoom-in-temp">+</div>
                            <div class="zoom-btn" id="zoom-out-temp">-</div>
                            <div class="zoom-btn reset" id="zoom-reset-temp">Reset</div>
                        </div>
                    </div>
                    <div class="history-range">
                        <div class="history-btn active" data-range="1h" id="range-temp-1h">1h</div>
                        <div class="history-btn" data-range="6h" id="range-temp-6h">6h</div>
                        <div class="history-btn" data-range="24h" id="range-temp-24h">24h</div>
                        <div class="history-btn" data-range="7d" id="range-temp-7d">7d</div>
                    </div>
                </div>

                <div id="consumption-chart-section" class="tab-content">
                    <div class="chart-container">
                        <canvas id="consumptionChart"></canvas>
                        <div class="zoom-controls">
                            <div class="zoom-btn" id="zoom-in-consumption">+</div>
                            <div class="zoom-btn" id="zoom-out-consumption">-</div>
                            <div class="zoom-btn reset" id="zoom-reset-consumption">Reset</div>
                        </div>
                    </div>
                    <div class="history-range">
                        <div class="history-btn active" data-range="1h" id="range-consumption-1h">1h</div>
                        <div class="history-btn" data-range="6h" id="range-consumption-6h">6h</div>
                        <div class="history-btn" data-range="24h" id="range-consumption-24h">24h</div>
                        <div class="history-btn" data-range="7d" id="range-consumption-7d">7d</div>
                    </div>
                </div>

                <div class="history-stats">
                    <div class="history-card">
                        <h3 class="history-title"><i class="fas fa-hourglass-half"></i> Czas pracy sesji</h3>
                        <div class="history-value" id="session-uptime">0h 0m 0s</div>
                        <button id="resetSessionBtn" class="reset-stats-btn warning"><i class="fas fa-redo-alt"></i> Resetuj sesję</button>
                    </div>
                    <div class="history-card">
                        <h3 class="history-title"><i class="fas fa-clock"></i> Całkowity czas pracy</h3>
                        <div class="history-value" id="total-uptime">0h 0m 0s</div>
                        <button id="resetHistoryBtn" class="reset-stats-btn danger"><i class="fas fa-history"></i> Resetuj historię (wymaga hasła)</button>
                        <input type="password" id="resetPasswordInput" placeholder="Wpisz hasło">
                    </div>
                    <div class="history-card">
                        <h3 class="history-title"><i class="fas fa-wifi"></i> Siła sygnału WiFi (RSSI)</h3>
                        <div class="history-value" id="wifi-rssi">-- dBm</div>
                    </div>
                    <div class="history-card">
                        <h3 class="history-title"><i class="fas fa-network-wired"></i> Adres IP</h3>
                        <div class="history-value" id="device-ip">---.---.---.---</div>
                    </div>
                    <div class="history-card">
                        <h3 class="history-title"><i class="fas fa-burn"></i> Godziny pracy palnika</h3>
                        <div class="history-value" id="burner-hours">0h 0m 0s</div>
                    </div>
                    <div class="history-card">
                        <h3 class="history-title"><i class="fas fa-weight-hanging"></i> Ilość pelletu w zbiorniku</h3>
                        <div class="history-value" id="pellet-level">--%</div>
                        <div class="progress-container">
                            <div class="progress-bar pellet-bar" id="pellet-level-progress" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="history-card">
                        <h3 class="history-title"><i class="fas fa-fire-alt"></i> Wydajność</h3>
                        <div class="history-value" id="efficiency-value">--%</div>
                        <div class="efficiency-gauge">
                            <div class="gauge-fill" id="efficiency-gauge-fill" style="width: 0%;"></div>
                            <span class="gauge-label" id="efficiency-gauge-label">--%</span>
                        </div>
                    </div>
                </div>

                <div class="cost-calculation">
                    <h3 class="card-title"><i class="fas fa-money-bill-wave"></i> Kalkulacja kosztów</h3>
                    <div class="cost-row">
                        <span>Cena pelletu (€/kg):</span>
                        <input type="number" step="0.01" value="0.30" id="pelletPriceInput" style="width: 80px; text-align: right; background: rgba(255,255,255,0.1); border: none; border-radius: 5px; color: white;">
                    </div>
                    <div class="cost-row">
                        <span>Zużycie pelletu (kg/h):</span>
                        <input type="number" step="0.1" value="1.5" id="pelletConsumptionInput" style="width: 80px; text-align: right; background: rgba(255,255,255,0.1); border: none; border-radius: 5px; color: white;">
                    </div>
                    <div class="cost-total">
                        <span>Szacowany całkowity koszt:</span>
                        <span id="totalCalculatedCost">0.00 €</span>
                    </div>
                </div>

                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-hourglass-half"></i>
                        <span>Czas do następnego czyszczenia</span>
                    </div>
                    <div class="auto-clean">
                        <div class="auto-clean-label">
                            <i class="fas fa-clock"></i> Czas do czyszczenia:
                        </div>
                        <span class="clean-timer" id="clean-countdown">0h 0m 0s</span>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 Sterowanie Piecem Peletowym. Wszelkie prawa zastrzeżone.</p>
        </footer>
    </div>

    <script>
        // Start of cdn.min.js content (reconstructed)

        // MQTT Client Setup
        let mqttClient;
        const mqttStatusIndicator = document.getElementById('mqtt-status-indicator');
        const mqttStatusText = document.getElementById('mqtt-status-text');
        const mqttLogElement = document.getElementById('mqtt-log');
        const mqttConnectBtn = document.getElementById('mqtt-connect-btn');
        const mqttDisconnectBtn = document.getElementById('mqtt-disconnect-btn');
        const mqttBrokerInput = document.getElementById('mqtt-broker');
        const mqttPortInput = document.getElementById('mqtt-port');
        const mqttUsernameInput = document.getElementById('mqtt-username');
        const mqttPasswordInput = document.getElementById('mqtt-password');

        const MQTT_STATE_TOPIC = "pellet/boiler/state";
        const MQTT_CONTROL_TOPIC = "pellet/boiler/control";
        const MQTT_TARGET_TEMP_TOPIC = "pellet/boiler/target_temp";
        const MQTT_POWER_TOPIC = "pellet/boiler/power";
        const MQTT_BLOWER_POWER_TOPIC = "pellet/boiler/blower_power";
        const MQTT_FEEDER_TIMES_TOPIC = "pellet/boiler/feeder_times";
        const MQTT_ASH_CLEAN_TOPIC = "pellet/boiler/ash_clean";
        const MQTT_MAINTENANCE_MODE_TOPIC = "pellet/boiler/maintenance_mode";
        const MQTT_BURNER_CORRECTION_TOPIC = "pellet/boiler/burner_correction";
        const MQTT_RESET_SESSION_TOPIC = "pellet/boiler/reset_session";
        const MQTT_RESET_HISTORY_TOPIC = "pellet/boiler/reset_history";
        const MQTT_BLOWER_MANUAL_CONTROL_TOPIC = "pellet/boiler/blower_manual_control";
        const MQTT_BLOWER_PURGE_MODE_TOPIC = "pellet/boiler/blower_purge_mode";
        const MQTT_BLOWER_PURGE_SETTINGS_TOPIC = "pellet/boiler/blower_purge_settings";


        function logMqttMessage(topic, message, type = 'received') {
            const now = new Date();
            const time = now.toTimeString().split(' ')[0];
            const logEntry = document.createElement('div');
            logEntry.classList.add('mqtt-log-entry');
            let messageContent = '';
            try {
                const parsed = JSON.parse(message);
                messageContent = JSON.stringify(parsed, null, 2); // Pretty print JSON
            } catch (e) {
                messageContent = message;
            }
            logEntry.innerHTML = `<span class="mqtt-log-time">[${time}]</span> <span class="mqtt-log-topic">${topic}</span>: <span class="mqtt-log-message">${messageContent}</span>`;
            mqttLogElement.prepend(logEntry); // Add to top
            if (mqttLogElement.children.length > 50) { // Keep log from getting too long
                mqttLogElement.removeChild(mqttLogElement.lastChild);
            }
        }

        function connectMqtt() {
            const broker = mqttBrokerInput.value;
            const port = parseInt(mqttPortInput.value);
            const username = mqttUsernameInput.value;
            const password = mqttPasswordInput.value;

            const clientId = 'web_client_' + Math.random().toString(16).substr(2, 8);
            const options = {
                clientId: clientId,
                username: username,
                password: password,
                clean: true // Clean session
            };

            // Use wss for port 8084 (WebSockets Secure) and ws for 8083 (WebSockets)
            const protocol = (port === 8084) ? 'wss' : 'ws';
            const host = `${protocol}://${broker}:${port}/mqtt`; // EMQX default WebSocket path is /mqtt

            mqttClient = mqtt.connect(host, options);

            mqttClient.on('connect', () => {
                console.log('Connected to MQTT Broker!');
                mqttStatusIndicator.classList.remove('mqtt-disconnected');
                mqttStatusIndicator.classList.add('connected');
                mqttStatusText.textContent = 'Połączono';
                logMqttMessage('MQTT', 'Połączono z brokerem', 'system');

                // Subscribe to state topic
                mqttClient.subscribe(MQTT_STATE_TOPIC, (err) => {
                    if (!err) {
                        logMqttMessage('MQTT', `Subskrybowano: ${MQTT_STATE_TOPIC}`, 'system');
                    } else {
                        console.error("Subscription error:", err);
                        logMqttMessage('MQTT', `Błąd subskrypcji ${MQTT_STATE_TOPIC}: ${err}`, 'error');
                    }
                });
            });

            mqttClient.on('message', (topic, message) => {
                const msgString = message.toString();
                // console.log(`Received message on topic ${topic}: ${msgString}`);
                logMqttMessage(topic, msgString, 'received');
                
                if (topic === MQTT_STATE_TOPIC) {
                    try {
                        const state = JSON.parse(msgString);
                        updateUI(state);
                    } catch (e) {
                        console.error("Error parsing state JSON:", e);
                        logMqttMessage('JSON Parse Error', msgString, 'error');
                    }
                }
            });

            mqttClient.on('error', (err) => {
                console.error('MQTT Error:', err);
                mqttStatusIndicator.classList.remove('connected');
                mqttStatusIndicator.classList.add('mqtt-disconnected');
                mqttStatusText.textContent = 'Błąd połączenia';
                logMqttMessage('MQTT', `Błąd: ${err}`, 'error');
                mqttClient.end(); // Close the client on error
            });

            mqttClient.on('close', () => {
                console.log('MQTT Connection closed.');
                mqttStatusIndicator.classList.remove('connected');
                mqttStatusIndicator.classList.add('mqtt-disconnected');
                mqttStatusText.textContent = 'Rozłączono';
                logMqttMessage('MQTT', 'Połączenie zamknięte', 'system');
            });

            mqttClient.on('offline', () => {
                console.log('MQTT Client is offline.');
                mqttStatusIndicator.classList.remove('connected');
                mqttStatusIndicator.classList.add('mqtt-disconnected');
                mqttStatusText.textContent = 'Offline';
                logMqttMessage('MQTT', 'Klient offline', 'system');
            });

            mqttClient.on('reconnect', () => {
                console.log('MQTT Client attempting to reconnect...');
                mqttStatusText.textContent = 'Ponowne łączenie...';
                logMqttMessage('MQTT', 'Próba ponownego połączenia...', 'system');
            });
        }

        function disconnectMqtt() {
            if (mqttClient) {
                mqttClient.end();
                console.log('Disconnected from MQTT Broker.');
                mqttStatusIndicator.classList.remove('connected');
                mqttStatusIndicator.classList.add('mqtt-disconnected');
                mqttStatusText.textContent = 'Rozłączono';
                logMqttMessage('MQTT', 'Rozłączono ręcznie', 'system');
            }
        }

        // UI Elements
        const waterTempEl = document.getElementById('water-temp');
        const roomTempEl = document.getElementById('room-temp');
        const burnerTempEl = document.getElementById('burner-temp');
        const exhaustTempEl = document.getElementById('exhaust-temp');
        const waterProgressEl = document.getElementById('water-progress');
        const waterStatusEl = document.getElementById('water-status');
        const targetTempEl = document.getElementById('target-temp');
        const powerBtn = document.getElementById('power-btn');
        const targetSlider = document.getElementById('target-slider');
        const targetDisplay = document.getElementById('target-display');
        const feederStatusEl = document.getElementById('feeder-status');
        const cycleProgressBar = document.getElementById('cycle-progress-bar');
        const feederCycleTimerEl = document.getElementById('feeder-cycle-timer');
        const feedTimeInput = document.getElementById('feed-time');
        const pauseTimeInput = document.getElementById('pause-time');
        const cleanAshBtn = document.getElementById('clean-ash-btn');
        const cleanCountdownEl = document.getElementById('clean-countdown');
        const cleanHoursInput = document.getElementById('clean-hours');
        const cleanMinutesInput = document.getElementById('clean-minutes');
        const cleanSecondsInput = document.getElementById('clean-seconds');
        const updateCleanBtn = document.getElementById('update-clean-btn');
        const maintenanceStatusEl = document.getElementById('maintenance-status');
        const toggleMaintenanceModeBtn = document.getElementById('toggleMaintenanceModeBtn');
        const maintenanceFeedTimeInput = document.getElementById('maintenance-feed-time');
        const maintenancePauseTimeInput = document.getElementById('maintenance-pause-time');
        const sessionUptimeEl = document.getElementById('session-uptime');
        const totalUptimeEl = document.getElementById('total-uptime');
        const resetSessionBtn = document.getElementById('resetSessionBtn');
        const resetHistoryBtn = document.getElementById('resetHistoryBtn');
        const resetPasswordInput = document.getElementById('resetPasswordInput');
        const wifiRssiEl = document.getElementById('wifi-rssi');
        const deviceIpEl = document.getElementById('device-ip');
        const burnerHoursEl = document.getElementById('burner-hours');
        const pelletLevelEl = document.getElementById('pellet-level');
        const pelletLevelProgress = document.getElementById('pellet-level-progress');
        const efficiencyValueEl = document.getElementById('efficiency-value');
        const efficiencyGaugeFill = document.getElementById('efficiency-gauge-fill');
        const efficiencyGaugeLabel = document.getElementById('efficiency-gauge-label');
        const mainChartSwitcherTemp = document.getElementById('main-chart-switcher-temp');
        const mainChartSwitcherConsumption = document.getElementById('main-chart-switcher-consumption');
        const temperatureChartSection = document.getElementById('temperature-chart-section');
        const consumptionChartSection = document.getElementById('consumption-chart-section');
        const pelletPriceInput = document.getElementById('pelletPriceInput');
        const pelletConsumptionInput = document.getElementById('pelletConsumptionInput');
        const totalCalculatedCost = document.getElementById('totalCalculatedCost');
        const burnerTempCorrectionInput = document.getElementById('burnerTempCorrectionInput');
        const burnerCorrectionDisplay = document.getElementById('burner-correction-display');
        const saveBurnerCorrectionBtn = document.getElementById('saveBurnerCorrectionBtn');
        const resetBurnerCorrectionBtn = document.getElementById('resetBurnerCorrectionBtn');
        const blowerStatusIndicatorMini = document.getElementById('blower-status-indicator-mini');
        const feederStatusIndicatorMini = document.getElementById('feeder-status-indicator-mini');
        const blowerPowerDisplay = document.getElementById('blower-power-display');
        const blowerPowerProgress = document.getElementById('blower-power-progress');
        const blowerPowerWorkSlider = document.getElementById('blower-power-work');
        const blowerPowerWorkDisplay = document.getElementById('blower-power-work-display');
        const blowerPowerMaintenanceSlider = document.getElementById('blower-power-maintenance');
        const blowerPowerMaintenanceDisplay = document.getElementById('blower-power-maintenance-display');
        const blowerPowerPurgeSlider = document.getElementById('blower-power-purge');
        const blowerPowerPurgeDisplay = document.getElementById('blower-power-purge-display');
        const blowerManualToggle = document.getElementById('blowerManualToggle');
        const blowerManualControls = document.querySelector('.blower-manual-controls');
        const manualBlowerPowerSlider = document.getElementById('manualBlowerPowerSlider');
        const manualBlowerPowerDisplay = document.getElementById('manualBlowerPowerDisplay');
        const blowerPurgeToggle = document.getElementById('blowerPurgeToggle');
        const blowerPurgeSettings = document.getElementById('blower-purge-settings');
        const blowerPurgeTimeInput = document.getElementById('blower-purge-time');
        const blowerPurgeIntervalInput = document.getElementById('blower-purge-interval');

        // Chart.js instances
        let temperatureChart;
        let consumptionChart;

        // History data (client-side)
        let temperatureHistory = [];
        let consumptionHistory = [];

        // Chart data visibility
        const datasetToggles = {
            'water': {
                id: 'toggle-water-temp',
                color: '#3498db',
                datasetIndex: 0
            },
            'room': {
                id: 'toggle-room-temp',
                color: '#e67e22',
                datasetIndex: 1
            },
            'burner': {
                id: 'toggle-burner-temp',
                color: '#e74c3c',
                datasetIndex: 2
            },
            'exhaust': {
                id: 'toggle-exhaust-temp',
                color: '#9b59b6',
                datasetIndex: 3
            }
        };

        // Utility function to format time
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h}h ${m}m ${s}s`;
        }

        // UI Update Function - main function to update all elements
        function updateUI(state) {
            waterTempEl.textContent = `${state.waterTemp.toFixed(1)}°C`;
            roomTempEl.textContent = `${state.roomTemp.toFixed(1)}°C`;
            burnerTempEl.textContent = `${state.burnerTemp.toFixed(1)}°C`;
            exhaustTempEl.textContent = `${state.exhaustTemp.toFixed(1)}°C`;

            const waterTempProgress = Math.min(100, (state.waterTemp / state.targetTemp) * 100);
            waterProgressEl.style.width = `${waterTempProgress}%`;
            waterStatusEl.className = 'status-indicator';
            if (state.waterTemp >= state.targetTemp) {
                waterStatusEl.classList.add('status-active');
            } else if (state.waterTemp >= state.targetTemp * 0.9) {
                waterStatusEl.classList.add('status-warning');
            } else {
                waterStatusEl.classList.add('status-inactive');
            }

            targetTempEl.textContent = state.targetTemp;
            targetDisplay.textContent = `${state.targetTemp}°C`;
            targetSlider.value = state.targetTemp;

            // Power button state
            if (state.power) {
                powerBtn.classList.remove('danger');
                powerBtn.classList.add('success');
                powerBtn.innerHTML = '<i class="fas fa-power-off"></i> WŁĄCZONY';
            } else {
                powerBtn.classList.remove('success');
                powerBtn.classList.add('danger');
                powerBtn.innerHTML = '<i class="fas fa-power-off"></i> WYŁĄCZONY';
            }

            // Feeder status and cycle
            let feederStatusText = "";
            let feederProgressBarColor = "";
            let feederStatusIndicatorClass = 'status-inactive';
            
            // Determine feeder status based on the complex cycle state
            switch(state.feederCycleState) {
                case "FEED_FORWARD":
                    feederStatusText = "PODAJNIK: PODAWANIE";
                    feederProgressBarColor = 'var(--feeder-forward-color)';
                    feederStatusIndicatorClass = 'status-active';
                    break;
                case "FEED_SHORT_PAUSE":
                    feederStatusText = "PODAJNIK: KRÓTKA PAUZA";
                    feederProgressBarColor = 'var(--feeder-pause-color)';
                    feederStatusIndicatorClass = 'status-warning';
                    break;
                case "FEED_REVERSE":
                    feederStatusText = "PODAJNIK: COFANIE";
                    feederProgressBarColor = 'var(--feeder-reverse-color)';
                    feederStatusIndicatorClass = 'status-active'; // Or another suitable status
                    break;
                case "FEED_OFF": // This also covers the long pause
                default:
                    feederStatusText = "PODAJNIK: PRZERWA";
                    feederProgressBarColor = 'var(--feeder-pause-color)';
                    feederStatusIndicatorClass = 'status-inactive';
                    break;
            }

            feederStatusEl.innerHTML = `<span class="status-indicator ${feederStatusIndicatorClass}"></span> ${feederStatusText}`;
            cycleProgressBar.style.backgroundColor = feederProgressBarColor;

            if (state.currentPhaseDuration > 0) {
                const progress = ((state.currentPhaseDuration - state.timeRemainingInPhase) / state.currentPhaseDuration) * 100;
                cycleProgressBar.style.width = `${progress}%`;
            } else {
                cycleProgressBar.style.width = '0%';
            }

            // Convert milliseconds to seconds for timer display
            const remainingSeconds = Math.ceil(state.timeRemainingInPhase / 1000);
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            feederCycleTimerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;


            feedTimeInput.value = state.feedOnTime;
            pauseTimeInput.value = state.feedOffTime;

            // Clean countdown
            cleanCountdownEl.textContent = formatTime(state.timeToClean);

            // Maintenance mode
            if (state.maintenanceMode) {
                maintenanceStatusEl.classList.remove('maintenance-inactive');
                maintenanceStatusEl.classList.add('maintenance-active');
                maintenanceStatusEl.textContent = 'AKTYWNY';
                toggleMaintenanceModeBtn.classList.remove('warning');
                toggleMaintenanceModeBtn.classList.add('danger');
                toggleMaintenanceModeBtn.innerHTML = '<i class="fas fa-toggle-off"></i> Wyłącz tryb konserwacji';
            } else {
                maintenanceStatusEl.classList.remove('maintenance-active');
                maintenanceStatusEl.classList.add('maintenance-inactive');
                maintenanceStatusEl.textContent = 'NIEAKTYWNY';
                toggleMaintenanceModeBtn.classList.remove('danger');
                toggleMaintenanceModeBtn.classList.add('warning');
                toggleMaintenanceModeBtn.innerHTML = '<i class="fas fa-toggle-on"></i> Włącz tryb konserwacji';
            }
            maintenanceFeedTimeInput.value = state.maintenanceFeedOnTime;
            maintenancePauseTimeInput.value = state.maintenanceFeedOffTime;

            // Uptime and history
            sessionUptimeEl.textContent = formatTime(state.sessionUptimeSeconds);
            totalUptimeEl.textContent = formatTime(state.totalUptimeSeconds);

            wifiRssiEl.textContent = `${state.rssi} dBm`;
            deviceIpEl.textContent = state.ipAddress;
            burnerHoursEl.textContent = formatTime(state.burnerHours);

            pelletLevelEl.textContent = `${state.pelletLevel}%`;
            pelletLevelProgress.style.width = `${state.pelletLevel}%`;

            efficiencyValueEl.textContent = `${state.efficiency}%`;
            efficiencyGaugeFill.style.width = `${state.efficiency}%`;
            efficiencyGaugeLabel.textContent = `${state.efficiency}%`;

            // Burner correction
            burnerCorrectionDisplay.textContent = `${state.burnerTempCorrection.toFixed(1)}°C`;
            burnerTempCorrectionInput.value = state.burnerTempCorrection;

            // Blower power
            blowerPowerDisplay.textContent = `${state.effectiveBlowerPower}%`;
            blowerPowerProgress.style.width = `${state.effectiveBlowerPower}%`;
            blowerPowerWorkSlider.value = state.blowerWorkPower;
            blowerPowerWorkDisplay.textContent = `${state.blowerWorkPower}%`;
            blowerPowerMaintenanceSlider.value = state.blowerMaintenanceManualPower; // Updated to new variable
            blowerPowerMaintenanceDisplay.textContent = `${state.blowerMaintenanceManualPower}%`; // Updated to new variable
            blowerPowerPurgeSlider.value = state.blowerPurgeManualPower;
            blowerPowerPurgeDisplay.textContent = `${state.blowerPurgeManualPower}%`;

            // Blower manual control toggle
            blowerManualToggle.checked = state.blowerManualControl;
            if (state.blowerManualControl) {
                blowerManualControls.style.display = 'block';
                manualBlowerPowerSlider.value = state.manualBlowerPower; // Assuming you have a 'manualBlowerPower' state
                manualBlowerPowerDisplay.textContent = `${state.manualBlowerPower}%`;
            } else {
                blowerManualControls.style.display = 'none';
            }

            // Blower purge mode toggle
            blowerPurgeToggle.checked = state.blowerPurgeMode;
            if (state.blowerPurgeMode) {
                blowerPurgeSettings.style.display = 'flex';
            } else {
                blowerPurgeSettings.style.display = 'none';
            }
            blowerPurgeTimeInput.value = state.blowerPurgeOnTime;
            blowerPurgeIntervalInput.value = state.blowerPurgeOffTime / 60; // Convert seconds to minutes

            // Blower and Feeder mini status indicators
            blowerStatusIndicatorMini.className = 'status-indicator';
            blowerStatusIndicatorMini.classList.add(state.blowerActive ? 'status-active' : 'status-inactive');

            feederStatusIndicatorMini.className = 'status-indicator';
            feederStatusIndicatorMini.classList.add(state.feederActive ? 'status-active' : 'status-inactive'); // Assuming feederActive is true when moving forward or reverse

            // Update charts
            updateCharts(state.historyData);

            // Recalculate cost (moved here to ensure it's always up-to-date with current state)
            calculateTotalCost();
        }

        // Initialize Charts
        function initializeCharts() {
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Temperatura Wody',
                        borderColor: '#3498db',
                        data: [],
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'Temperatura Pokojowa',
                        borderColor: '#e67e22',
                        data: [],
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'Temperatura Palnika',
                        borderColor: '#e74c3c',
                        data: [],
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'Temperatura Spalin',
                        borderColor: '#9b59b6',
                        data: [],
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                tooltipFormat: 'HH:mm:ss',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            adapters: {
                                date: Luxon.DateTime
                            },
                            title: {
                                display: true,
                                text: 'Czas',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperatura (°C)',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // We use custom toggles
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    },
                    animation: {
                        duration: 0 // Disable animation for real-time data
                    }
                }
            });

            const consCtx = document.getElementById('consumptionChart').getContext('2d');
            consumptionChart = new Chart(consCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Zużycie Pelletu (kg/h)',
                        borderColor: '#2ecc71',
                        data: [],
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                tooltipFormat: 'HH:mm:ss',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            adapters: {
                                date: Luxon.DateTime
                            },
                            title: {
                                display: true,
                                text: 'Czas',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Zużycie (kg/h)',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
        }

        // Update Charts with new data
        function updateCharts(historyData) {
            temperatureChart.data.datasets[0].data = historyData.map(p => ({ x: p.timestamp_ms, y: p.water_temp }));
            temperatureChart.data.datasets[1].data = historyData.map(p => ({ x: p.timestamp_ms, y: p.room_temp }));
            temperatureChart.data.datasets[2].data = historyData.map(p => ({ x: p.timestamp_ms, y: p.burner_temp }));
            temperatureChart.data.datasets[3].data = historyData.map(p => ({ x: p.timestamp_ms, y: p.exhaust_temp }));
            temperatureChart.update();

            consumptionChart.data.datasets[0].data = historyData.map(p => ({ x: p.timestamp_ms, y: p.pellet_consumption_rate }));
            consumptionChart.update();
        }

        // Event Listeners
        window.addEventListener('load', () => {
            initializeCharts();
            // Attempt to connect to MQTT on load
            connectMqtt();
        });

        mqttConnectBtn.addEventListener('click', connectMqtt);
        mqttDisconnectBtn.addEventListener('click', disconnectMqtt);

        powerBtn.addEventListener('click', () => {
            if (mqttClient && mqttClient.connected) {
                const newState = powerBtn.classList.contains('danger'); // If it's OFF (danger), click to turn ON
                mqttClient.publish(MQTT_POWER_TOPIC, JSON.stringify({ power: newState }), 0, false);
                logMqttMessage(MQTT_POWER_TOPIC, `{"power": ${newState}}`, 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        targetSlider.addEventListener('input', () => {
            const temp = targetSlider.value;
            targetDisplay.textContent = `${temp}°C`;
        });

        targetSlider.addEventListener('change', () => {
            if (mqttClient && mqttClient.connected) {
                const targetTemp = parseFloat(targetSlider.value);
                mqttClient.publish(MQTT_TARGET_TEMP_TOPIC, JSON.stringify({ targetTemp: targetTemp }), 0, false);
                logMqttMessage(MQTT_TARGET_TEMP_TOPIC, `{"targetTemp": ${targetTemp}}`, 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        // Feeder and Blower settings (send on change)
        feedTimeInput.addEventListener('change', () => {
            if (mqttClient && mqttClient.connected) {
                const feedOnTime = parseInt(feedTimeInput.value);
                const pauseOnTime = parseInt(pauseTimeInput.value);
                mqttClient.publish(MQTT_FEEDER_TIMES_TOPIC, JSON.stringify({ feedOnTime: feedOnTime, pauseOnTime: pauseOnTime }), 0, false);
                logMqttMessage(MQTT_FEEDER_TIMES_TOPIC, `{"feedOnTime": ${feedOnTime}, "pauseOnTime": ${pauseOnTime}}`, 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        pauseTimeInput.addEventListener('change', () => {
            if (mqttClient && mqttClient.connected) {
                const feedOnTime = parseInt(feedTimeInput.value);
                const pauseOnTime = parseInt(pauseTimeInput.value);
                mqttClient.publish(MQTT_FEEDER_TIMES_TOPIC, JSON.stringify({ feedOnTime: feedOnTime, pauseOnTime: pauseOnTime }), 0, false);
                logMqttMessage(MQTT_FEEDER_TIMES_TOPIC, `{"feedOnTime": ${feedOnTime}, "pauseOnTime": ${pauseOnTime}}`, 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });
        
        // Blower power sliders
        blowerPowerWorkSlider.addEventListener('input', () => {
            blowerPowerWorkDisplay.textContent = `${blowerPowerWorkSlider.value}%`;
        });
        blowerPowerWorkSlider.addEventListener('change', () => sendBlowerPowerSettings());

        blowerPowerMaintenanceSlider.addEventListener('input', () => {
            blowerPowerMaintenanceDisplay.textContent = `${blowerPowerMaintenanceSlider.value}%`;
        });
        blowerPowerMaintenanceSlider.addEventListener('change', () => sendBlowerPowerSettings());

        blowerPowerPurgeSlider.addEventListener('input', () => {
            blowerPowerPurgeDisplay.textContent = `${blowerPowerPurgeSlider.value}%`;
        });
        blowerPowerPurgeSlider.addEventListener('change', () => sendBlowerPowerSettings());

        function sendBlowerPowerSettings() {
            if (mqttClient && mqttClient.connected) {
                const settings = {
                    work: parseInt(blowerPowerWorkSlider.value),
                    maintenance: parseInt(blowerPowerMaintenanceSlider.value),
                    purge: parseInt(blowerPowerPurgeSlider.value)
                };
                mqttClient.publish(MQTT_BLOWER_POWER_TOPIC, JSON.stringify(settings), 0, false);
                logMqttMessage(MQTT_BLOWER_POWER_TOPIC, JSON.stringify(settings), 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        }

        // Blower manual toggle
        blowerManualToggle.addEventListener('change', () => {
            if (mqttClient && mqttClient.connected) {
                const manualControl = blowerManualToggle.checked;
                mqttClient.publish(MQTT_BLOWER_MANUAL_CONTROL_TOPIC, JSON.stringify({ manualControl: manualControl }), 0, false);
                logMqttMessage(MQTT_BLOWER_MANUAL_CONTROL_TOPIC, `{"manualControl": ${manualControl}}`, 'sent');
                if (manualControl) {
                    blowerManualControls.style.display = 'block';
                } else {
                    blowerManualControls.style.display = 'none';
                }
            } else {
                alert('Brak połączenia z brokerem MQTT!');
                blowerManualToggle.checked = !blowerManualToggle.checked; // Revert
            }
        });

        manualBlowerPowerSlider.addEventListener('input', () => {
            manualBlowerPowerDisplay.textContent = `${manualBlowerPowerSlider.value}%`;
        });
        manualBlowerPowerSlider.addEventListener('change', () => {
            if (mqttClient && mqttClient.connected) {
                const manualPower = parseInt(manualBlowerPowerSlider.value);
                mqttClient.publish(MQTT_BLOWER_POWER_TOPIC, JSON.stringify({ manualPower: manualPower }), 0, false); // Assuming a single topic for all blower power settings, or new topic
                logMqttMessage(MQTT_BLOWER_POWER_TOPIC, `{"manualPower": ${manualPower}}`, 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });
        
        // Blower purge toggle and settings
        blowerPurgeToggle.addEventListener('change', () => {
            if (mqttClient && mqttClient.connected) {
                const purgeMode = blowerPurgeToggle.checked;
                mqttClient.publish(MQTT_BLOWER_PURGE_MODE_TOPIC, JSON.stringify({ purgeMode: purgeMode }), 0, false);
                logMqttMessage(MQTT_BLOWER_PURGE_MODE_TOPIC, `{"purgeMode": ${purgeMode}}`, 'sent');
                if (purgeMode) {
                    blowerPurgeSettings.style.display = 'flex';
                } else {
                    blowerPurgeSettings.style.display = 'none';
                }
            } else {
                alert('Brak połączenia z brokerem MQTT!');
                blowerPurgeToggle.checked = !blowerPurgeToggle.checked; // Revert
            }
        });

        blowerPurgeTimeInput.addEventListener('change', () => sendBlowerPurgeSettings());
        blowerPurgeIntervalInput.addEventListener('change', () => sendBlowerPurgeSettings());

        function sendBlowerPurgeSettings() {
            if (mqttClient && mqttClient.connected) {
                const purgeTime = parseInt(blowerPurgeTimeInput.value);
                const purgeInterval = parseInt(blowerPurgeIntervalInput.value) * 60; // Convert minutes to seconds
                mqttClient.publish(MQTT_BLOWER_PURGE_SETTINGS_TOPIC, JSON.stringify({ purgeTime: purgeTime, purgeInterval: purgeInterval }), 0, false);
                logMqttMessage(MQTT_BLOWER_PURGE_SETTINGS_TOPIC, `{"purgeTime": ${purgeTime}, "purgeInterval": ${purgeInterval}}`, 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        }


        cleanAshBtn.addEventListener('click', () => {
            if (mqttClient && mqttClient.connected) {
                if (confirm("Czy na pewno chcesz uruchomić czyszczenie popiołu?")) {
                    mqttClient.publish(MQTT_ASH_CLEAN_TOPIC, JSON.stringify({ command: "start" }), 0, false);
                    logMqttMessage(MQTT_ASH_CLEAN_TOPIC, `{"command": "start"}`, 'sent');
                }
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        updateCleanBtn.addEventListener('click', () => {
            if (mqttClient && mqttClient.connected) {
                const hours = parseInt(cleanHoursInput.value) || 0;
                const minutes = parseInt(cleanMinutesInput.value) || 0;
                const seconds = parseInt(cleanSecondsInput.value) || 0;
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                mqttClient.publish(MQTT_ASH_CLEAN_TOPIC, JSON.stringify({ setTime: totalSeconds }), 0, false);
                logMqttMessage(MQTT_ASH_CLEAN_TOPIC, `{"setTime": ${totalSeconds}}`, 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        toggleMaintenanceModeBtn.addEventListener('click', () => {
            if (mqttClient && mqttClient.connected) {
                // Determine current maintenance state from UI, then send opposite
                const currentMaintenanceState = maintenanceStatusEl.classList.contains('maintenance-active');
                mqttClient.publish(MQTT_MAINTENANCE_MODE_TOPIC, JSON.stringify({ enable: !currentMaintenanceState }), 0, false);
                logMqttMessage(MQTT_MAINTENANCE_MODE_TOPIC, `{"enable": ${!currentMaintenanceState}}`, 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        maintenanceFeedTimeInput.addEventListener('change', () => sendMaintenanceTimes());
        maintenancePauseTimeInput.addEventListener('change', () => sendMaintenanceTimes());

        function sendMaintenanceTimes() {
            if (mqttClient && mqttClient.connected) {
                const feed = parseInt(maintenanceFeedTimeInput.value);
                const pause = parseInt(maintenancePauseTimeInput.value);
                mqttClient.publish(MQTT_MAINTENANCE_MODE_TOPIC, JSON.stringify({ feedOnTime: feed, feedOffTime: pause }), 0, false);
                logMqttMessage(MQTT_MAINTENANCE_MODE_TOPIC, `{"feedOnTime": ${feed}, "feedOffTime": ${pause}}`, 'sent');
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        }

        saveBurnerCorrectionBtn.addEventListener('click', () => {
            if (mqttClient && mqttClient.connected) {
                const correction = parseFloat(burnerTempCorrectionInput.value);
                if (!isNaN(correction)) {
                    mqttClient.publish(MQTT_BURNER_CORRECTION_TOPIC, JSON.stringify({ correction: correction }), 0, false);
                    logMqttMessage(MQTT_BURNER_CORRECTION_TOPIC, `{"correction": ${correction}}`, 'sent');
                } else {
                    alert('Wprowadź prawidłową wartość korekty.');
                }
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        resetBurnerCorrectionBtn.addEventListener('click', () => {
            if (mqttClient && mqttClient.connected) {
                if (confirm("Czy na pewno chcesz zresetować korektę temperatury palnika?")) {
                    mqttClient.publish(MQTT_BURNER_CORRECTION_TOPIC, JSON.stringify({ reset: true }), 0, false);
                    logMqttMessage(MQTT_BURNER_CORRECTION_TOPIC, `{"reset": true}`, 'sent');
                }
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        resetSessionBtn.addEventListener('click', () => {
            if (mqttClient && mqttClient.connected) {
                if (confirm("Czy na pewno chcesz zresetować statystyki sesji?")) {
                    mqttClient.publish(MQTT_RESET_SESSION_TOPIC, JSON.stringify({ reset: true }), 0, false);
                    logMqttMessage(MQTT_RESET_SESSION_TOPIC, `{"reset": true}`, 'sent');
                }
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        resetHistoryBtn.addEventListener('click', () => {
            if (mqttClient && mqttClient.connected) {
                const password = resetPasswordInput.value;
                if (password === mqttPasswordInput.value) { // Use MQTT password as a security measure
                    if (confirm("Jesteś pewien, że chcesz zresetować CAŁĄ historię? Tej operacji nie można cofnąć!")) {
                        mqttClient.publish(MQTT_RESET_HISTORY_TOPIC, JSON.stringify({ reset: true, password: password }), 0, false);
                        logMqttMessage(MQTT_RESET_HISTORY_TOPIC, `{"reset": true, "password": "****"}`, 'sent');
                        resetPasswordInput.value = ''; // Clear password field
                    }
                } else {
                    alert('Nieprawidłowe hasło!');
                }
            } else {
                alert('Brak połączenia z brokerem MQTT!');
            }
        });

        // Chart switching logic
        mainChartSwitcherTemp.addEventListener('click', () => {
            mainChartSwitcherTemp.classList.add('active');
            mainChartSwitcherConsumption.classList.remove('active');
            temperatureChartSection.classList.add('active');
            consumptionChartSection.classList.remove('active');
            temperatureChart.resize(); // Ensure chart redraws correctly
        });

        mainChartSwitcherConsumption.addEventListener('click', () => {
            mainChartSwitcherConsumption.classList.add('active');
            mainChartSwitcherTemp.classList.remove('active');
            temperatureChartSection.classList.remove('active');
            consumptionChartSection.classList.add('active');
            consumptionChart.resize(); // Ensure chart redraws correctly
        });

        // Chart dataset toggles
        for (const key in datasetToggles) {
            const toggle = document.getElementById(datasetToggles[key].id);
            toggle.addEventListener('click', () => {
                const dataset = temperatureChart.data.datasets[datasetToggles[key].datasetIndex];
                dataset.hidden = !dataset.hidden;
                toggle.classList.toggle('active', !dataset.hidden);
                temperatureChart.update();
            });
        }

        // Chart zoom controls (simplified for direct Chart.js zoom plugin)
        document.getElementById('zoom-in-temp').addEventListener('click', () => temperatureChart.zoom(1.1));
        document.getElementById('zoom-out-temp').addEventListener('click', () => temperatureChart.zoom(0.9));
        document.getElementById('zoom-reset-temp').addEventListener('click', () => temperatureChart.resetZoom());

        document.getElementById('zoom-in-consumption').addEventListener('click', () => consumptionChart.zoom(1.1));
        document.getElementById('zoom-out-consumption').addEventListener('click', () => consumptionChart.zoom(0.9));
        document.getElementById('zoom-reset-consumption').addEventListener('click', () => consumptionChart.resetZoom());

        // History range buttons (simplified to client-side filtering, assuming full history from server)
        document.querySelectorAll('.history-range .history-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.history-range .history-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                const range = this.dataset.range;
                filterChartData(range);
            });
        });

        function filterChartData(range) {
            const now = Luxon.DateTime.now().toMillis();
            let startTime;
            switch (range) {
                case '1h': startTime = now - 3600 * 1000; break;
                case '6h': startTime = now - 6 * 3600 * 1000; break;
                case '24h': startTime = now - 24 * 3600 * 1000; break;
                case '7d': startTime = now - 7 * 24 * 3600 * 1000; break;
                default: startTime = 0; // Show all
            }

            const filteredTempData = temperatureHistory.filter(p => p.timestamp_ms >= startTime);
            const filteredConsumptionData = consumptionHistory.filter(p => p.timestamp_ms >= startTime);

            temperatureChart.data.datasets[0].data = filteredTempData.map(p => ({ x: p.timestamp_ms, y: p.water_temp }));
            temperatureChart.data.datasets[1].data = filteredTempData.map(p => ({ x: p.timestamp_ms, y: p.room_temp }));
            temperatureChart.data.datasets[2].data = filteredTempData.map(p => ({ x: p.timestamp_ms, y: p.burner_temp }));
            temperatureChart.data.datasets[3].data = filteredTempData.map(p => ({ x: p.timestamp_ms, y: p.exhaust_temp }));
            temperatureChart.update();

            consumptionChart.data.datasets[0].data = filteredConsumptionData.map(p => ({ x: p.timestamp_ms, y: p.pellet_consumption_rate }));
            consumptionChart.update();
        }

        // Cost calculation logic
        function calculateTotalCost() {
            const pricePerKg = parseFloat(pelletPriceInput.value);
            const consumptionRateKgPerHour = parseFloat(pelletConsumptionInput.value);
            const burnerHours = parseTimeToHours(burnerHoursEl.textContent); // Convert "0h 0m 0s" to hours

            if (!isNaN(pricePerKg) && !isNaN(consumptionRateKgPerHour) && !isNaN(burnerHours)) {
                const totalPelletConsumedKg = consumptionRateKgPerHour * burnerHours;
                const totalCost = totalPelletConsumedKg * pricePerKg;
                totalCalculatedCost.textContent = `${totalCost.toFixed(2)} €`;
            } else {
                totalCalculatedCost.textContent = `N/A`;
            }
        }

        // Helper to parse "Xh Ym Zs" string to total hours
        function parseTimeToHours(timeString) {
            const parts = timeString.match(/(\d+)h (\d+)m (\d+)s/);
            if (parts) {
                const h = parseInt(parts[1]);
                const m = parseInt(parts[2]);
                const s = parseInt(parts[3]);
                return h + (m / 60) + (s / 3600);
            }
            return 0;
        }

        pelletPriceInput.addEventListener('change', calculateTotalCost);
        pelletConsumptionInput.addEventListener('change', calculateTotalCost);

        // Initial UI update with default values
        updateUI({
            power: false,
            targetTemp: 70.0,
            waterTemp: 25.0,
            roomTemp: 22.0,
            burnerTemp: 25.0,
            exhaustTemp: 30.0,
            feederCycleState: "FEED_OFF",
            timeRemainingInPhase: 0,
            currentPhaseDuration: 0,
            feedOnTime: 5,
            feedOffTime: 30,
            timeToClean: 0,
            maintenanceMode: false,
            maintenanceFeedOnTime: 2,
            maintenancePauseTime: 5,
            sessionUptimeSeconds: 0,
            totalUptimeSeconds: 0,
            rssi: -60,
            ipAddress: '---.---.---.---',
            burnerHours: 0,
            pelletLevel: 0,
            efficiency: 0,
            burnerTempCorrection: 0.0,
            effectiveBlowerPower: 0,
            blowerWorkPower: 70,
            blowerMaintenanceManualPower: 30, // Default for new variable
            blowerPurgeManualPower: 100,
            blowerManualControl: false,
            manualBlowerPower: 0,
            blowerPurgeMode: false,
            blowerPurgeOnTime: 10,
            blowerPurgeOffTime: 300,
            blowerActive: false,
            feederActive: false,
            historyData: []
        });

        // End of cdn.min.js content (reconstructed)
    </script>
</body>
</html>
)=====";
